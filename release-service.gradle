buildscript {
    repositories {
        mavenCentral()
        jcenter()
        maven { url "https://plugins.gradle.org/m2/" }
    }
    dependencies {
        classpath 'org.ajoberstar:grgit:1.7.2'
    }
}

apply plugin: 'maven'
apply plugin: 'maven-publish'
apply from: 'release-commons.gradle'

task releaseDockerfile(type: Copy) {
    /* copy dockerfile and replace version of JAR */
    from('docker/Dockerfile-release')

    filter(org.apache.tools.ant.filters.ReplaceTokens, tokens: project.properties.findAll { it.value instanceof String }.collectEntries {
        [it.key, it.value]
    })

    into "${project.projectDir}/"
    rename('Dockerfile-release', 'Dockerfile')
}

task addDockerfileToGit << {
    grgit = org.ajoberstar.grgit.Grgit.open(dir: '.')

    grgit.add(patterns: ['Dockerfile'])
}

task removeDockerfileFromGit << {
    grgit = org.ajoberstar.grgit.Grgit.open(dir: '.')

    grgit.remove(patterns: ['Dockerfile'])
}


addDockerfileToGit.dependsOn releaseDockerfile
updateVersion.dependsOn removeDockerfileFromGit
beforeReleaseBuild.dependsOn addDockerfileToGit
afterReleaseBuild.dependsOn bintrayUpload